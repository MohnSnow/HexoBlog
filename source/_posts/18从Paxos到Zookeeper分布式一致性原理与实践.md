---
title: 从Paxos到Zookeeper分布式一致性原理与实践
date: 2017-08-14 18:07:19
tags: Java Paxos Zookeeper
categories: "分布式"
toc: true
---
#### 一.分布式架构
1. 从集中式到分布式
2. 从ACID到CAP/BASE
<!--more-->

#### 二.一致性协议
经典的一致性协议和算法为:两段式提交、三段式提交和PAXOS算法
##### 1.2PC Two-Phase-Commit
1. 绝大多数分布式数据库都是采用二段式提交协议来完成分布式协议处理的。
2. 包括两个阶段:提交事务请求和执行事务提交
3. 优点: 1.原理简单 2.实现方便
4. 缺点; 1.同步阻塞 2.单点问题 3.脑裂 4.太过保守

##### 2.分布式系统常见问题
数据冗余情况下考虑数据的一致性和性能的问题。简单说来：
1. 要想让数据有高可用性，就得写多份数据。
2. 写多份的问题会导致数据一致性的问题。
3. 数据一致性的问题又会引发性能问题

##### 3.一致性模型、
说起数据一致性来说，简单说有三种类型（当然，如果细分的话，还有很多一致性模型，如：顺序一致性，FIFO一致性，会话一致性，单读一致性，单写一致性，但为了本文的简单易读，我只说下面三种）：
1. Weak 弱一致性：当你写入一个新值后，读操作在数据副本上可能读出来，也可能读不出来。比如：某些cache系统，网络游戏其它玩家的数据和你没什么关系，VOIP这样的系统，或是百度搜索引擎（呵呵）。
2. Eventually 最终一致性：当你写入一个新值后，有可能读不出来，但在某个时间窗口之后保证最终能读出来。比如：DNS，电子邮件、Amazon S3，Google搜索引擎这样的系统。
3. Strong 强一致性：新的数据一旦写入，在任意副本任意时刻都能读到新值。比如：文件系统，RDBMS，Azure Table都是强一致性的。

具体细分:
1. Master-Slave: 读写请求都由Master负责,写请求写到Master上后，由Master同步到Slave上。
2. Master-Master: Master-Master，又叫Multi-master，是指一个系统存在两个或多个Master，每个Master都提供read-write服务。这个模型是Master-Slave的加强版，数据间同步一般是通过Master间的异步完成，所以是最终一致性。
3. Two/Three Phase Commit:
2PC:
第一阶段：
协调者会问所有的参与者结点，是否可以执行提交操作。
各个参与者开始事务执行的准备工作：如：为资源上锁，预留资源，写undo/redo log……
参与者响应协调者，如果事务的准备工作成功，则回应“可以提交”，否则回应“拒绝提交”。
第二阶段：
如果所有的参与者都回应“可以提交”，那么，协调者向所有的参与者发送“正式提交”的命令。参与者完成正式提交，并释放所有资源，然后回应“完成”，协调者收集各结点的“完成”回应后结束这个Global Transaction。
如果有一个参与者回应“拒绝提交”，那么，协调者向所有的参与者发送“回滚操作”，并释放所有资源，然后回应“回滚完成”，协调者收集各结点的“回滚”回应后，取消这个Global Transaction。
2PC存在问题:
1）如果第一阶段中，参与者没有收到询问请求，或是参与者的回应没有到达协调者。那么，需要协调者做超时处理，一旦超时，可以当作失败，也可以重试。
2）如果第二阶段中，正式提交发出后，如果有的参与者没有收到，或是参与者提交/回滚后的确认信息没有返回，一旦参与者的回应超时，要么重试，要么把那个参与者标记为问题结点剔除整个集群，这样可以保证服务结点都是数据一致性的。
3）糟糕的情况是，第二阶段中，如果参与者收不到协调者的commit/fallback指令，参与者将处于“状态未知”阶段，参与者完全不知道要怎么办，比如：如果所有的参与者完成第一阶段的回复后（可能全部yes，可能全部no，可能部分yes部分no），如果协调者在这个时候挂掉了。那么所有的结点完全不知道怎么办（问别的参与者都不行）。为了一致性，要么死等协调者，要么重发第一阶段的yes/no命令。
为了解决第三种问题,单点问题,发明了3PC:
4. Two Generals Problem（两将军问题）: 试图通过建立在一个不可靠的连接上的交流来协调一项行动的隐患和设计上的巨大挑战。
5. 拜占庭将军问题 (Byzantine Generals Problem):
6. Paxos算法: Paxos 算法解决的问题是在一个可能发生上述异常的分布式系统中如何就某个值达成一致，保证不论发生以上任何异常，都不会破坏决议的一致性。Paxos的目的是让整个集群的结点对某个值的变更达成一致。
